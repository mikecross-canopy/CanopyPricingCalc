<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canopy Pricing Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F1F3F7;
        }
        .canopy-primary-accent {
            background-color: #0BE6C7;
        }
        .canopy-primary-accent-text {
            color: #0BE6C7;
        }
        .canopy-primary-accent-border {
            border-color: #0BE6C7 !important;
        }
        .item-selected-border {
            border-color: #0BE6C7 !important;
            border-width: 2px !important;
        }
        .canopy-main-text {
            color: #000000;
        }
        .canopy-secondary-text {
            color: #374151;
        }
        .billing-toggle-bg {
            background-color: #e2e8f0;
        }
        .billing-label.active {
            color: #0BE6C7;
            font-weight: 600;
        }
        .custom-checkbox:checked {
            background-color: #0BE6C7;
            border-color: #0BE6C7;
        }

        input[type="number"].module-user-input,
        select.data-migration-select,
        select.implementation-tier-select,
        input[type="number"].additional-clients-input { /* Added additional-clients-input */
            border: 1px solid #cbd5e0;
            padding: 0.35rem 0.5rem;
            border-radius: 0.375rem;
            color: #000000;
            text-align: center;
        }

        input[type="number"].module-user-input {
             width: 80px;
        }
        input[type="number"].additional-clients-input { /* Styling for additional clients input */
            width: 100px;
        }

        select.data-migration-select,
        select.implementation-tier-select {
            text-align: left;
            padding-right: 2rem;
        }
        select.data-migration-select {
             width: 100%;
        }

        input[type="number"].module-user-input:disabled,
        input[type="number"].additional-clients-input:disabled { /* Added additional-clients-input */
            background-color: #edf2f7;
            cursor: not-allowed;
        }

        .summary-panel {
            background-color: #000000;
            color: #FFFFFF;
            border-left: none;
        }
        .summary-panel h3.summary-section-header {
            color: #FFFFFF;
            font-size: 1.125rem; /* 18px */
            font-weight: 600;
            margin-bottom: 0.75rem; /* 12px */
            padding-bottom: 0.5rem; /* 8px */
            border-bottom: 1px solid #4A5563; /* Slightly darker gray for better contrast on black */
            text-align: center;
        }
        .summary-item {
            display: grid;
            grid-template-columns: 2fr auto 1fr; /* Label, Quantity, Value */
            gap: 0.5rem; /* 8px */
            padding: 0.65rem 0; /* ~10px vertical padding */
            border-bottom: 1px solid #4A5563;
            font-size: 0.875rem; /* 14px */
            align-items: center;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item-label {
            color: #D1D5DB; /* Lighter gray for labels */
            font-weight: 500;
        }
        .summary-item-quantity {
            color: #D1D5DB;
            text-align: center;
        }
        .summary-item-value {
            color: #FFFFFF;
            font-weight: 600;
            text-align: right;
        }

        .discreet-discount-input {
            border: none;
            background-color: #FFFFFF;
            color: #9CA3AF;
            width: 70px;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            text-align: center;
        }
        .discreet-discount-input::placeholder {
            color: #D1D5DB;
        }

        .peer:checked + span { /* For the billing toggle */
            background-color: #0BE6C7 !important;
        }

        /* Client Engagement Platform Styling */
        .ce-platform-section { border: 2px solid #e2e8f0; border-radius: 0.5rem; padding: 1.25rem; position: relative; }
        .ce-platform-section.selected { border-color: #0BE6C7; box-shadow: 0 0 0 2px #0BE6C7; }
        .ce-tier-selector { display: flex; margin-bottom: 1.25rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; overflow: hidden; }
        .ce-tier-button { flex: 1; padding: 0.65rem 1rem; text-align: center; background-color: #FFFFFF; color: #374151; cursor: pointer; border-right: 1px solid #D1D5DB; transition: background-color 0.2s ease-in-out; }
        .ce-tier-button:last-child { border-right: none; }
        .ce-tier-button.active { background-color: #0BE6C7; color: #FFFFFF; font-weight: 600; }
        .ce-tier-button .tier-name { display: block; font-size: 0.9rem; font-weight: 600; }
        .ce-tier-button .tier-recommendation { display: block; font-size: 0.7rem; color: #6B7280; }
        .ce-tier-button.active .tier-recommendation { color: #E0FEFA; }
        .ce-details { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; } /* Added margin-bottom */
        .ce-feature-list { list-style: none; padding-left: 0; font-size: 0.8rem; color: #374151; }
        .ce-feature-list li { padding-left: 1.25rem; position: relative; margin-bottom: 0.25rem; }
        .ce-feature-list li::before { content: '✓'; color: #0BE6C7; position: absolute; left: 0; font-weight: bold; }
        .ce-price-display { text-align: right; flex-shrink: 0; margin-left: 1.5rem; }
        .ce-price-display .price { font-size: 2rem; font-weight: 800; color: #000000; line-height: 1; }
        .ce-price-display .price-term { font-size: 0.8rem; color: #6B7280; display: block; }
        /* .ce-price-display .implementation-note { font-size: 0.7rem; color: #6B7280; margin-top: 0.25rem; } */ /* Removed */

        .additional-clients-section { /* Styling for the new section */
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed #cbd5e0;
        }
        .additional-clients-section label {
            font-size: 0.9rem;
            color: #374151;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        .additional-clients-rate-info {
            font-size: 0.75rem;
            color: #6B7280;
            margin-left: 0.5rem;
        }


        /* Module Card Styling (also used for Tax Resolution Addon) */
        .modules-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; }
        .module-card, .addon-card-module-style {
            background-color: #FFFFFF;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: border-color 0.2s ease-in-out, border-width 0.2s ease-in-out;
            cursor: pointer;
        }
        .addon-card {
            background-color: #FFFFFF; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem;
            display: flex; flex-direction: column; justify-content: space-between;
            transition: border-color 0.2s ease-in-out, border-width 0.2s ease-in-out; cursor: pointer;
        }

        .module-card-header, .addon-card-header-module-style {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .module-card-title, .addon-card-title-module-style {
            font-size: 1.05rem;
            font-weight: 700;
            color: #000000;
        }
        .module-card-price, .addon-card-price-module-style {
            font-size: 1.35rem;
            font-weight: 700;
            color: #000000;
            margin-bottom: 0.15rem;
            line-height: 1.2;
        }
        .module-card-price-term, .addon-card-price-term-module-style {
            font-size: 0.7rem;
            color: #6B7280;
            display: block;
            margin-bottom: 0.75rem;
        }
        .module-feature-list, .addon-description-module-style {
            list-style: none;
            padding-left: 0;
            font-size: 0.8rem;
            color: #4A5568;
            margin-bottom: 1rem;
            flex-grow: 1;
        }
        .module-feature-list li { padding-left: 1.25rem; position: relative; margin-bottom: 0.25rem; }
        .module-feature-list li::before { content: '✓'; color: #0BE6C7; position: absolute; left: 0; }

        .module-card-actions, .addon-card-actions-module-style {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }

        .addon-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .addon-card-title { font-size: 1.05rem; font-weight: 700; color: #000000; }
        .addon-card-description { font-size: 0.7rem; color: #4A5568; margin-bottom: 0.25rem; }
        .addon-card-pricing { font-size: 0.8rem; color: #374151; margin-bottom: 0.25rem; }
        .addon-card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 0.75rem; border-top: 1px solid #e2e8f0; }

        .info-icon {
            font-size: 0.8rem;
            color: #0BE6C7;
            border: 1px solid #0BE6C7;
            border-radius: 50%;
            width: 1.1rem;
            height: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: help;
        }

    </style>
</head>
<body class="canopy-main-text">

    <div class="w-full max-w-screen-2xl mx-auto p-4 md:p-6">
        <header class="text-center mb-8">
            <img src="Canopy Just logo Black.png" alt="Canopy Logo" class="mx-auto h-16 mb-3" onerror="this.style.display='none'; console.error('Logo image not found.')">
            </header>

        <div class="flex flex-col lg:flex-row gap-6">
            <div class="lg:w-3/5 bg-white p-4 md:p-6 rounded-lg shadow-xl flex flex-col">
                <div>
                    <div class="flex justify-center items-center mb-8">
                        <span id="monthlyLabel" class="billing-label canopy-secondary-text mr-3 text-sm md:text-base font-medium active">Monthly</span>
                        <label for="billingToggleInput" class="relative inline-block w-12 h-6 billing-toggle-bg rounded-full cursor-pointer">
                            <input type="checkbox" id="billingToggleInput" class="sr-only peer">
                            <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-full peer-checked:bg-teal-500"></span>
                        </label>
                        <span id="annualLabel" class="billing-label canopy-secondary-text ml-3 text-sm md:text-base font-medium">Annually</span>
                    </div>

                    <div class="mb-8"> <h3 class="text-lg font-semibold canopy-main-text mb-3">Client Engagement Platform</h3>
                        <div class="ce-tier-selector">
                            <div id="ceTierStandardButton" class="ce-tier-button active">
                                <span class="tier-name">STANDARD</span>
                                <span class="tier-recommendation">Recommended for small firms</span>
                            </div>
                            <div id="ceTierProButton" class="ce-tier-button">
                                <span class="tier-name">PRO</span>
                                <span class="tier-recommendation">Recommended for growing firms</span>
                            </div>
                        </div>
                        <div id="clientEngagementDetails" class="ce-platform-section selected">
                            {/* Content injected by renderClientEngagementDetails */}
                        </div>
                         <div class="hidden">
                            <input type="radio" name="clientEngagementTier" id="clientEngagementTierStandard" value="standard" checked>
                            <input type="radio" name="clientEngagementTier" id="clientEngagementTierPro" value="pro">
                        </div>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-lg font-semibold canopy-main-text mb-3">Modules</h3>
                        <div id="selectableModulesContainer" class="modules-grid"></div>
                    </div>

                    <div class="mb-8">
                         <h3 class="text-lg font-semibold canopy-main-text mb-3">Add-ons</h3>
                         <div id="addonsContainerSummary" class="space-y-3">
                         </div>
                    </div>
                </div>

                <div class="mt-auto pt-4 border-t border-dashed border-gray-300">
                     <div class="text-right">
                         <label for="discountPercentage" class="text-xs text-gray-500 mr-1"></label>
                         <input type="number" id="discountPercentage" name="discountPercentage" value="0" min="0" max="100" class="discreet-discount-input" placeholder="%">
                     </div>
                </div>
            </div>

            <div class="lg:w-2/5 flex flex-col gap-6">
                <div class="summary-panel p-4 md:p-6 rounded-lg shadow-lg">
                    <div id="summaryHeaderTotal" class="text-center mb-4 pb-4 border-b border-gray-700">
                    </div>
                    <h3 class="summary-section-header">Pricing Breakdown</h3>
                    <div id="summaryPanelContent" class="space-y-1">
                    </div>
                </div>

                <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl">
                    <h3 class="text-lg font-semibold canopy-main-text mb-3 border-b pb-2">Implementation & Onboarding</h3>
                    <div class="pt-2 space-y-3">
                        <div class="flex justify-between items-center">
                            <label for="implementationTierSelect" class="text-sm canopy-secondary-text whitespace-nowrap mr-2">Implementation:</label>
                            <div class="flex items-center space-x-1 w-full">
                                <select id="implementationTierSelect" name="implementationTierSelect" class="implementation-tier-select !py-1 !px-2 !text-sm !border-gray-300 !rounded flex-grow">
                                </select>
                                <span class="text-gray-500 mx-1">-</span>
                                <div class="flex items-center border border-gray-300 rounded focus-within:ring-1 focus-within:ring-indigo-500 focus-within:border-indigo-500">
                                    <span class="text-sm text-gray-500 pl-2 pr-1 py-1">$</span>
                                    <input type="number" id="implementationFeeInput" name="implementationFeeInput" value="0" min="0"
                                           class="!py-1 !px-1 !text-sm !border-none !w-16 text-right font-semibold focus:ring-0">
                                </div>
                            </div>
                        </div>
                        <div class="text-right -mt-2">
                             <a id="implementationInfoLink" href="#" target="_blank" class="text-xs canopy-primary-accent-text hover:underline">more info</a>
                        </div>
                        <div class="flex justify-between items-center pt-1">
                            <label for="dataMigrationSelect" class="text-sm canopy-secondary-text">Data Migration:</label>
                            <div class="w-3/5">
                                <select id="dataMigrationSelect" name="dataMigrationSelect" class="data-migration-select"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <a href="SmallFirm.html"
                       class="canopy-primary-accent hover:opacity-80 text-white font-semibold py-2 px-6 rounded-md shadow-md transition-opacity text-sm inline-block">
                        View Plans for Small Firms &rarr;
                    </a>
                </div>
                 </div>
        </div>

        <footer class="text-center mt-10 text-sm text-gray-500">
            <p>&copy; <span id="currentYear"></span> Canopy</p>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const billingToggleInput = document.getElementById('billingToggleInput');
        const monthlyLabel = document.getElementById('monthlyLabel');
        const annualLabel = document.getElementById('annualLabel');
        const currentYearSpan = document.getElementById('currentYear');
        const discountPercentageInput = document.getElementById('discountPercentage');
        const implementationTierSelect = document.getElementById('implementationTierSelect');
        const implementationInfoLink = document.getElementById('implementationInfoLink');
        const implementationFeeInput = document.getElementById('implementationFeeInput');
        const dataMigrationSelect = document.getElementById('dataMigrationSelect');
        const selectableModulesContainer = document.getElementById('selectableModulesContainer');
        const addonsContainerSummary = document.getElementById('addonsContainerSummary');
        const summaryPanelContent = document.getElementById('summaryPanelContent');
        const summaryHeaderTotalDiv = document.getElementById('summaryHeaderTotal');
        const clientEngagementDetailsDiv = document.getElementById('clientEngagementDetails');
        const ceTierStandardButton = document.getElementById('ceTierStandardButton');
        const ceTierProButton = document.getElementById('ceTierProButton');
        const clientEngagementTierStandardRadio = document.getElementById('clientEngagementTierStandard');
        const clientEngagementTierProRadio = document.getElementById('clientEngagementTierPro');
        let additionalClientsInput; // Will be assigned in renderClientEngagementDetails


        // --- Pricing Configuration ---
        const pricing = {
            monthly_premium_factor: 1.20,
            base_client_engagement: {
                standard: { name: "Client Engagement - Standard", effective_monthly_rate_on_annual_plan: 150, recommendation: "Recommended for small firms", features: ["Client Portal", "Mobile App for Clients & Firm", "Connected Email", "Notify team w/ @mentions", "CRM", "Client Engagement Platform includes 2,500 clients"] }, // Removed "(add more as you need)"
                pro: { name: "Client Engagement - Pro", effective_monthly_rate_on_annual_plan: 175, recommendation: "Recommended for growing firms", features: ["Engagements & Proposals w/ eSignature", "Client Requests", "Questionnaires & Organizers", "Custom Branding", "Custom Reports & Firm Analytics", "All Standard Features", "Client Engagement Platform includes 2,500 clients"] } // Removed "(add more as you need)"
            },
            additional_client_rate_monthly: 0.10416667, // Monthly rate per additional client
            implementation_tiers: {
                standard: { name: "Standard", percentage: 0.15, minimum_fee: 1500, info_link: "ImpComparison.pdf" },
                premium: { name: "Premium", percentage: 0.20, minimum_fee: 1500, info_link: "ImpComparison.pdf" }
            },
            data_migration_options: {
                none: { name: "Select an option...", price: 0 },
                filecabinet: { name: "FileCabinet", price: 1000 },
                smartvault: { name: "SmartVault", price: 500 },
                upload_only: { name: "Upload Only", price: 500 },
                revver: { name: "Revver", price: 1000 },
                general: { name: "General Data Migration", price: 750 }
            },
            selectable_modules: {
                document_management: { name: "Document Management", id_checkbox: "moduleDocManagementCheck", id_user_input: "moduleDocManagementUsers", features: ["Secure File Exchange", "Unlimited Document Storage", "Unlimited eSignatures", "Retention Policies", "Customizable Folder Permissions", "Native File Annotations", "Firm Workpaper Storage", "Desktop Sync & Print Driver"], standard_tier_pricing: [ { user_max: 3, price_per_user_annual_equiv: 40 }, { user_max: 9, price_per_user_annual_equiv: 36 }, { user_max: Infinity, price_per_user_annual_equiv: 40 * (1 - 0.15) } ], pro_tier_pricing: [ { user_max: 3, price_per_user_annual_equiv: 40 }, { user_max: 9, price_per_user_annual_equiv: 36 }, { user_max: Infinity, price_per_user_annual_equiv: 40 * (1 - 0.15) } ] },
                workflow: { name: "Workflow", id_checkbox: "moduleWorkflowCheck", id_user_input: "moduleWorkflowUsers", features: ["Projects & Tasks", "Automation", "Workflow Templates", "Recurrences", "Custom Statuses"], standard_tier_pricing: [ { user_max: 3, price_per_user_annual_equiv: 35 }, { user_max: 9, price_per_user_annual_equiv: 32 }, { user_max: Infinity, price_per_user_annual_equiv: 35 * (1 - 0.15) } ], pro_tier_pricing: [ { user_max: 3, price_per_user_annual_equiv: 45 }, { user_max: 9, price_per_user_annual_equiv: 45 * (1 - 0.10) },  { user_max: Infinity, price_per_user_annual_equiv: 45 * (1 - 0.15) }  ] },
                time_billing: { name: "Time & Billing", id_checkbox: "moduleTimeBillingCheck", id_user_input: "moduleTimeBillingUsers", features: ["Generate & Send Invoices", "Time Tracking", "WIP", "Collect Card & ACH Payments", "Surcharging", "Pre-Built Reports"], standard_tier_pricing: [ { user_max: 3, price_per_user_annual_equiv: 25 }, { user_max: 9, price_per_user_annual_equiv: 22 }, { user_max: Infinity, price_per_user_annual_equiv: 25 * (1 - 0.15) } ], pro_tier_pricing: [ { user_max: 3, price_per_user_annual_equiv: 35 }, { user_max: 9, price_per_user_annual_equiv: 35 * (1 - 0.10) }, { user_max: Infinity, price_per_user_annual_equiv: 35 * (1 - 0.15) } ] }
            },
            addons: {
                tax_resolution: { name: "Tax Resolution", description: "includes Transcripts and Notices", id_checkbox: "addonTaxResolutionCheck", id_user_input: "addonTaxResolutionUsers", price_per_user_annual_equiv: 50, info_tooltip: "Detailed information about Tax Resolution Suite." }
            }
        };

        let isAnnualBilling = false;
        let selectedCEtierValue = 'standard';
        let manualImplFeeSet = false;
        let previousNumericSubscriptionHeaderValue = 0;

        // --- Helper Functions ---
        function formatNumberWithCommas(number) {
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function animateValue(element, start, end, duration, suffix = '', prefix = '$') {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentValue = Math.floor(progress * (end - start) + start);
                element.textContent = `${prefix}${formatNumberWithCommas(currentValue)}${suffix}`; // Apply comma formatting here
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    element.textContent = `${prefix}${formatNumberWithCommas(end.toFixed(0))}${suffix}`; // Ensure final value is exact and formatted
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- Core Functions ---
        function populateImplementationTiers() {
            implementationTierSelect.innerHTML = '';
            for (const key in pricing.implementation_tiers) {
                const tier = pricing.implementation_tiers[key];
                const optionElement = document.createElement('option');
                optionElement.value = key;
                optionElement.textContent = tier.name;
                implementationTierSelect.appendChild(optionElement);
            }
            if (implementationTierSelect.value && pricing.implementation_tiers[implementationTierSelect.value]) {
                 implementationInfoLink.href = pricing.implementation_tiers[implementationTierSelect.value].info_link;
            } else if (Object.keys(pricing.implementation_tiers).length > 0) {
                const firstKey = Object.keys(pricing.implementation_tiers)[0];
                implementationInfoLink.href = pricing.implementation_tiers[firstKey].info_link;
            }
        }

        function populateDataMigrationOptions() {
            dataMigrationSelect.innerHTML = '';
            for (const key in pricing.data_migration_options) {
                const option = pricing.data_migration_options[key];
                const optionElement = document.createElement('option');
                optionElement.value = key;
                optionElement.textContent = option.price > 0 ? `${option.name} ($${formatNumberWithCommas(option.price)})` : option.name; // Comma format
                dataMigrationSelect.appendChild(optionElement);
            }
        }

        function renderClientEngagementDetails() {
            const tierData = pricing.base_client_engagement[selectedCEtierValue];
            let priceDisplay, priceTerm;

            if (isAnnualBilling) {
                priceDisplay = `$${formatNumberWithCommas(tierData.effective_monthly_rate_on_annual_plan.toFixed(0))}`;
                priceTerm = "/mo with annual contract";
            } else {
                priceDisplay = `$${formatNumberWithCommas((tierData.effective_monthly_rate_on_annual_plan * pricing.monthly_premium_factor).toFixed(0))}`;
                priceTerm = "/mo for unlimited users";
            }

            let featuresHTML = '<ul class="ce-feature-list mt-4 md:mt-0">';
            tierData.features.forEach(feature => { featuresHTML += `<li>${feature}</li>`; });
            featuresHTML += '</ul>';

            // Additional Clients Section HTML
            const additionalClientsHTML = `
                <div class="additional-clients-section">
                    <div class="flex items-center">
                        <label for="additionalClientsInput">Additional Clients:</label>
                        <input type="number" id="additionalClientsInput" name="additionalClientsInput" value="0" min="0" class="additional-clients-input">
                        <span class="additional-clients-rate-info">($${pricing.additional_client_rate_monthly.toFixed(2)}/client/mo)</span>
                    </div>
                </div>
            `;

            clientEngagementDetailsDiv.innerHTML = `
                <div class="ce-details">
                    <div>${featuresHTML}</div>
                    <div class="ce-price-display">
                        <div class="price">${priceDisplay}</div>
                        <div class="price-term">${priceTerm}</div>
                        
                    </div>
                </div>
                ${additionalClientsHTML} 
            `;
            
            // Get and assign the new input element
            additionalClientsInput = document.getElementById('additionalClientsInput');
            if(additionalClientsInput) { // Add event listener if element exists
                additionalClientsInput.addEventListener('input', calculateAndUpdatePrice);
            }


            ceTierStandardButton.classList.toggle('active', selectedCEtierValue === 'standard');
            ceTierProButton.classList.toggle('active', selectedCEtierValue === 'pro');
            clientEngagementDetailsDiv.classList.toggle('selected', true);
        }

        function updateBasePackageTierDisplay() {
            // Logic removed as per request
        }

        function createSelectableItemEntry(key, itemData, container, itemType) {
            const div = document.createElement('div');
            const checkboxId = itemData.id_checkbox;
            const userInputId = itemData.id_user_input;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = checkboxId;
            checkbox.name = checkboxId;
            checkbox.className = 'custom-checkbox h-5 w-5 border-gray-300 rounded focus:ring-transparent flex-shrink-0';
            checkbox.dataset.itemKey = key;
            checkbox.dataset.itemType = itemType;

            const userInput = document.createElement('input');
            userInput.type = 'number';
            userInput.id = userInputId;
            userInput.name = userInputId;
            userInput.value = "0";
            userInput.min = "0";
            userInput.className = 'module-user-input';
            userInput.disabled = true;


            if (itemType === 'addon' && key === 'tax_resolution') {
                div.className = 'addon-card-module-style'; 

                const headerDiv = document.createElement('div');
                headerDiv.className = 'addon-card-header-module-style';
                const titleSpan = document.createElement('h4');
                titleSpan.className = 'addon-card-title-module-style';
                titleSpan.textContent = itemData.name;
                if (itemData.info_tooltip) {
                    const infoIcon = document.createElement('span');
                    infoIcon.className = 'info-icon ml-2';
                    infoIcon.textContent = 'i';
                    infoIcon.title = itemData.info_tooltip;
                    titleSpan.appendChild(infoIcon);
                }
                headerDiv.appendChild(titleSpan);
                headerDiv.appendChild(checkbox);
                div.appendChild(headerDiv);

                const priceDiv = document.createElement('div');
                priceDiv.className = 'addon-card-price-module-style';
                priceDiv.id = `${checkboxId}_price_display`;
                priceDiv.textContent = '$0';
                div.appendChild(priceDiv);

                const priceTermSpan = document.createElement('span');
                priceTermSpan.className = 'addon-card-price-term-module-style';
                priceTermSpan.id = `${checkboxId}_price_term_display`;
                priceTermSpan.textContent = 'per user/mo';
                div.appendChild(priceTermSpan);

                if (itemData.description) {
                    const descP = document.createElement('p');
                    descP.className = 'addon-description-module-style text-sm text-gray-600 mb-4';
                    descP.textContent = itemData.description;
                    div.appendChild(descP);
                }
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'addon-card-actions-module-style';
                const userLabel = document.createElement('label');
                userLabel.htmlFor = userInputId;
                userLabel.className = 'text-xs text-gray-600 mr-2';
                userLabel.textContent = 'Users:';
                actionsDiv.appendChild(userLabel);
                actionsDiv.appendChild(userInput);
                div.appendChild(actionsDiv);

            } else if (itemType === 'addon') { 
                div.className = 'addon-card';
                const headerDiv = document.createElement('div'); headerDiv.className = 'addon-card-header';
                const titleSpan = document.createElement('span'); titleSpan.className = 'addon-card-title text-lg'; titleSpan.textContent = itemData.name;
                headerDiv.appendChild(titleSpan); headerDiv.appendChild(checkbox); div.appendChild(headerDiv);
                if (itemData.description) { const descP = document.createElement('p'); descP.className = 'addon-card-description'; descP.textContent = itemData.description; div.appendChild(descP); }
                const pricingP = document.createElement('p'); pricingP.className = 'addon-card-pricing'; pricingP.id = `${checkboxId}_price_display`; div.appendChild(pricingP);
                const itemActionsDiv = document.createElement('div'); itemActionsDiv.className = 'addon-card-actions';
                const userLabelText = itemData.is_consumption_based ? (itemData.unit_name || "Quantity") + ":" : "Users:";
                const userLabel = document.createElement('label'); userLabel.htmlFor = userInputId; userLabel.className = 'text-xs text-gray-600 mr-2'; userLabel.textContent = userLabelText;
                itemActionsDiv.appendChild(userLabel); itemActionsDiv.appendChild(userInput); div.appendChild(itemActionsDiv);

            } else { 
                div.className = 'module-card';
                const headerDiv = document.createElement('div'); headerDiv.className = 'module-card-header';
                const titleSpan = document.createElement('h4'); titleSpan.className = 'module-card-title'; titleSpan.textContent = itemData.name;
                headerDiv.appendChild(titleSpan); headerDiv.appendChild(checkbox); div.appendChild(headerDiv);
                const priceDiv = document.createElement('div'); priceDiv.className = 'module-card-price'; priceDiv.id = `${checkboxId}_price_display`; priceDiv.textContent = '$0'; div.appendChild(priceDiv);
                const priceTermSpan = document.createElement('span'); priceTermSpan.className = 'module-card-price-term'; priceTermSpan.id = `${checkboxId}_price_term_display`; priceTermSpan.textContent = 'per user/mo'; div.appendChild(priceTermSpan);
                const featuresUl = document.createElement('ul'); featuresUl.className = 'module-feature-list';
                (itemData.features || []).forEach(featureText => { const li = document.createElement('li'); li.textContent = featureText; featuresUl.appendChild(li); });
                div.appendChild(featuresUl);
                const actionsDiv = document.createElement('div'); actionsDiv.className = 'module-card-actions';
                const userLabel = document.createElement('label'); userLabel.htmlFor = userInputId; userLabel.className = 'text-xs text-gray-600 mr-2'; userLabel.textContent = 'Users:';
                actionsDiv.appendChild(userLabel); actionsDiv.appendChild(userInput); div.appendChild(actionsDiv);
            }

            div.addEventListener('click', (event) => {
                if (event.target !== userInput && event.target !== checkbox && !event.target.closest('label[for="' + userInputId + '"]')) {
                    checkbox.checked = !checkbox.checked;
                    const changeEvent = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(changeEvent);
                }
            });

            checkbox.addEventListener('change', (event) => {
                userInput.disabled = !event.target.checked;
                div.classList.toggle('item-selected-border', event.target.checked);
                if (!event.target.checked) {
                    userInput.value = "0";
                } else if (userInput.value === "0") {
                    userInput.value = (itemData.is_consumption_based && key !== 'tax_resolution') ? "10" : "1";
                }
                calculateAndUpdatePrice();
            });
            userInput.addEventListener('input', calculateAndUpdatePrice);

            container.appendChild(div);
        }


        function renderAllSelectableItems() {
            selectableModulesContainer.innerHTML = ''; addonsContainerSummary.innerHTML = '';
            for (const key in pricing.selectable_modules) {
                createSelectableItemEntry(key, pricing.selectable_modules[key], selectableModulesContainer, 'module');
            }
            const addonKeys = Object.keys(pricing.addons);
            if (addonKeys.length > 0 && addonKeys.every(key => key === 'tax_resolution' || pricing.addons[key].styleAsModule)) {
                addonsContainerSummary.className = 'modules-grid';
            } else {
                addonsContainerSummary.className = 'space-y-3';
            }
            for (const key in pricing.addons) {
                createSelectableItemEntry(key, pricing.addons[key], addonsContainerSummary, 'addon');
            }
        }

        function toggleBillingCycle() {
            isAnnualBilling = billingToggleInput.checked;
            monthlyLabel.classList.toggle('active', !isAnnualBilling);
            annualLabel.classList.toggle('active', isAnnualBilling);
            updateBasePackageTierDisplay();
            renderClientEngagementDetails(); // Re-render to update additional client rate display if needed
            manualImplFeeSet = false;
            calculateAndUpdatePrice();
        }

        function getPerUserAnnualEquivalentPrice(userCount, pricingTiersForItem) {
            if (!pricingTiersForItem) return 0;
            for (const tier of pricingTiersForItem) {
                if (userCount <= tier.user_max) {
                    return tier.price_per_user_annual_equiv;
                }
            }
            return 0;
        }

        function updateSummaryPanel(summaryData) {
            summaryPanelContent.innerHTML = '';
            summaryHeaderTotalDiv.innerHTML = '';

            const headerSubscriptionVal = document.createElement('div');
            headerSubscriptionVal.className = 'text-5xl font-extrabold canopy-primary-accent-text leading-tight';
            animateValue(
                headerSubscriptionVal,
                previousNumericSubscriptionHeaderValue,
                summaryData.numericSubscriptionForHeader,
                500,
                summaryData.subscriptionHeaderSuffix
            );
            previousNumericSubscriptionHeaderValue = summaryData.numericSubscriptionForHeader;
            summaryHeaderTotalDiv.appendChild(headerSubscriptionVal);

            const headerSubscriptionFreqText = document.createElement('div');
            headerSubscriptionFreqText.className = 'text-sm text-gray-300 mt-1';
            headerSubscriptionFreqText.textContent = summaryData.subscriptionForHeaderDescription;
            summaryHeaderTotalDiv.appendChild(headerSubscriptionFreqText);

            function addSummaryItem(label, quantity, value, isStrong = false, isGreen = false) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'summary-item';
                if (isStrong) itemDiv.classList.add('font-semibold');

                const labelSpan = document.createElement('span');
                labelSpan.className = 'summary-item-label';
                labelSpan.textContent = label;

                const quantitySpan = document.createElement('span');
                quantitySpan.className = 'summary-item-quantity';
                quantitySpan.textContent = quantity;

                const valueSpan = document.createElement('span');
                valueSpan.className = 'summary-item-value';
                if (isGreen) valueSpan.classList.add('canopy-primary-accent-text');
                valueSpan.textContent = value;

                itemDiv.appendChild(labelSpan);
                itemDiv.appendChild(quantitySpan);
                itemDiv.appendChild(valueSpan);
                summaryPanelContent.appendChild(itemDiv);
            }

            function addSummarySeparator() {
                const separatorDiv = document.createElement('div');
                separatorDiv.className = 'pt-2 mt-2 border-t border-gray-700';
                summaryPanelContent.appendChild(separatorDiv);
            }

            addSummaryItem('Tier:', '', summaryData.ceTierName);
            addSummaryItem('Client Engagement Platform:', '', summaryData.ceCostDisplay);
            if (summaryData.additionalClientsCostForDisplay && summaryData.additionalClientsCostForDisplay !== '$0') {
                 addSummaryItem('Additional Clients:', `${formatNumberWithCommas(summaryData.additionalClientsCount)}`, summaryData.additionalClientsCostForDisplay);
            }


            summaryData.moduleDetails.forEach(mod => {
                addSummaryItem(mod.name, `${formatNumberWithCommas(mod.users)} ${mod.unitName || 'Users'}`, mod.costDisplay);
            });
            summaryData.addonDetails.forEach(addon => {
                addSummaryItem(addon.name, `${formatNumberWithCommas(addon.users)} ${addon.unitName || (pricing.addons[addon.key]?.is_consumption_based ? (pricing.addons[addon.key]?.unit_name || 'items') : 'Users')}`, addon.costDisplay);
            });


            let hasModulesOrAddons = summaryData.moduleDetails.length > 0 || summaryData.addonDetails.length > 0;

            if (summaryData.discountPercent > 0) {
                if (hasModulesOrAddons || (summaryData.additionalClientsCostForDisplay && summaryData.additionalClientsCostForDisplay !== '$0')) addSummarySeparator();
                addSummaryItem('Subscription Subtotal:', '', summaryData.subscriptionSubtotalDisplay);
                addSummaryItem('Discount Applied:', `(${summaryData.discountPercent}%)`, summaryData.discountAmountDisplay, false, true);
            }

            const hasOneTimeFees = summaryData.implementationFeeForDisplay !== '$0' || summaryData.dataMigrationFeeForDisplay !== '$0';
            if (hasOneTimeFees) {
                 if (hasModulesOrAddons || summaryData.discountPercent > 0 || summaryData.ceCostDisplay !== '$0' || (summaryData.additionalClientsCostForDisplay && summaryData.additionalClientsCostForDisplay !== '$0')) {
                     addSummarySeparator();
                 }
                if (summaryData.implementationFeeForDisplay !== '$0') {
                    addSummaryItem(`Implementation (${summaryData.implementationTierName}):`, '', summaryData.implementationFeeForDisplay);
                }
                if (summaryData.dataMigrationFeeForDisplay !== '$0') {
                    addSummaryItem(`Data Migration (${summaryData.dataMigrationName}):`, '', summaryData.dataMigrationFeeForDisplay);
                }
            }

            if (summaryData.ceCostDisplay !== '$0' || hasModulesOrAddons || hasOneTimeFees || summaryData.discountPercent > 0 || (summaryData.additionalClientsCostForDisplay && summaryData.additionalClientsCostForDisplay !== '$0') ) {
                 addSummarySeparator();
            }
            addSummaryItem('Grand Total:', '', summaryData.grandTotalForBreakdownDisplay, true, false);
        }

        function calculateAndUpdatePrice() {
            let totalMonthlySubscriptionCostAnnualEquiv = 0; // Base for CE and modules/addons with annual equiv pricing
            let directMonthlyCosts = 0; // For items like additional clients priced directly per month

            const summaryDetails = {
                moduleDetails: [],
                addonDetails: [],
                discountPercent: 0,
                subscriptionSubtotalDisplay: '$0',
                discountAmountDisplay: '-$0',
                implementationTierName: '',
                implementationFeeForDisplay: '$0',
                dataMigrationFeeForDisplay: '$0',
                dataMigrationName: '',
                grandTotalForBreakdownDisplay: '$0',
                numericSubscriptionForHeader: 0,
                subscriptionHeaderSuffix: '/mo',
                subscriptionForHeaderDescription: 'Monthly Subscription',
                ceTierName: '',
                ceCostDisplay: '$0',
                additionalClientsCount: 0,
                additionalClientsCostForDisplay: '$0'
            };

            summaryDetails.ceTierName = selectedCEtierValue.charAt(0).toUpperCase() + selectedCEtierValue.slice(1);
            let baseCEAnnualEquivMonthlyRate = pricing.base_client_engagement[selectedCEtierValue].effective_monthly_rate_on_annual_plan;
            totalMonthlySubscriptionCostAnnualEquiv += baseCEAnnualEquivMonthlyRate;
            if (isAnnualBilling) {
                summaryDetails.ceCostDisplay = `$${formatNumberWithCommas( (baseCEAnnualEquivMonthlyRate * 12).toFixed(0))}/yr`;
            } else {
                summaryDetails.ceCostDisplay = `$${formatNumberWithCommas( (baseCEAnnualEquivMonthlyRate * pricing.monthly_premium_factor).toFixed(0))}/mo`;
            }

            // Calculate Additional Clients Cost
            const numAdditionalClients = additionalClientsInput ? parseInt(additionalClientsInput.value) || 0 : 0;
            summaryDetails.additionalClientsCount = numAdditionalClients;
            if (numAdditionalClients > 0) {
                const costPerAdditionalClientMonthly = pricing.additional_client_rate_monthly;
                directMonthlyCosts += numAdditionalClients * costPerAdditionalClientMonthly;
                if(isAnnualBilling){
                    summaryDetails.additionalClientsCostForDisplay = `$${formatNumberWithCommas((numAdditionalClients * costPerAdditionalClientMonthly * 12).toFixed(2))}/yr`;
                } else {
                    summaryDetails.additionalClientsCostForDisplay = `$${formatNumberWithCommas((numAdditionalClients * costPerAdditionalClientMonthly).toFixed(2))}/mo`;
                }
            }


            function updateItemDetailDisplay(itemIdCheckbox, perUserCostText, itemTotalCostText, itemKey, itemType) {
                const priceDisplayEl = document.getElementById(`${itemIdCheckbox}_price_display`);
                const priceTermEl = document.getElementById(`${itemIdCheckbox}_price_term_display`);

                if (itemType === 'module' || (itemType === 'addon' && itemKey === 'tax_resolution')) {
                    if (priceDisplayEl && priceTermEl) {
                        const parts = perUserCostText.match(/^(\$\d+(?:,\d{3})*)(.*)/); // Regex to capture formatted dollar amount
                        if (parts) {
                            priceDisplayEl.textContent = parts[1]; 
                            priceTermEl.textContent = parts[2].trim(); 
                        } else { 
                            const firstSpaceIndex = perUserCostText.indexOf(' ');
                            if (firstSpaceIndex > -1) {
                                priceDisplayEl.textContent = perUserCostText.substring(0, firstSpaceIndex);
                                priceTermEl.textContent = perUserCostText.substring(firstSpaceIndex + 1);
                            } else {
                                priceDisplayEl.textContent = perUserCostText;
                                priceTermEl.textContent = '';
                            }
                        }
                    }
                } else if (itemType === 'addon') {
                     if (priceDisplayEl) {
                         const addonData = pricing.addons[itemKey];
                         if (perUserCostText === "$0" && addonData?.is_consumption_based) {
                              priceDisplayEl.textContent = `$${formatNumberWithCommas(addonData.price_per_item.toFixed(2))} per ${addonData.unit_name || 'item'}`;
                         } else {
                             priceDisplayEl.textContent = perUserCostText;
                         }
                     }
                }
            }


            for (const key in pricing.selectable_modules) {
                const moduleData = pricing.selectable_modules[key];
                const checkbox = document.getElementById(moduleData.id_checkbox);
                const userInput = document.getElementById(moduleData.id_user_input);
                const moduleUsers = parseInt(userInput.value) || 0;
                let itemPerUserDisplay = "$0";
                let moduleDisplayCostForSummary = "$0";

                let pricePerUserAnnualEquiv = 0;
                const pricingTiers = selectedCEtierValue === 'pro' ? moduleData.pro_tier_pricing : moduleData.standard_tier_pricing;
                pricePerUserAnnualEquiv = getPerUserAnnualEquivalentPrice(moduleUsers > 0 ? moduleUsers : 1, pricingTiers); // Use 1 user for unselected price display

                if (checkbox && checkbox.checked && moduleUsers > 0) {
                    totalMonthlySubscriptionCostAnnualEquiv += (pricePerUserAnnualEquiv * moduleUsers);
                    if (isAnnualBilling) {
                        itemPerUserDisplay = `$${formatNumberWithCommas(pricePerUserAnnualEquiv.toFixed(0))} per user/mo (annual plan)`;
                        moduleDisplayCostForSummary = `$${formatNumberWithCommas((pricePerUserAnnualEquiv * moduleUsers * 12).toFixed(0))}/yr`;
                    } else {
                        let actualMonthlyPricePerUser = pricePerUserAnnualEquiv * pricing.monthly_premium_factor;
                        itemPerUserDisplay = `$${formatNumberWithCommas(actualMonthlyPricePerUser.toFixed(0))} per user/mo`;
                        moduleDisplayCostForSummary = `$${formatNumberWithCommas((actualMonthlyPricePerUser * moduleUsers).toFixed(0))}/mo`;
                    }
                    summaryDetails.moduleDetails.push({ name: moduleData.name, users: moduleUsers, costDisplay: moduleDisplayCostForSummary, unitName: "Users" });
                } else { // For unselected items, show the base price
                     if (isAnnualBilling) {
                        itemPerUserDisplay = `$${formatNumberWithCommas(pricePerUserAnnualEquiv.toFixed(0))} per user/mo (annual plan)`;
                    } else {
                        let actualMonthlyPricePerUser = pricePerUserAnnualEquiv * pricing.monthly_premium_factor;
                        itemPerUserDisplay = `$${formatNumberWithCommas(actualMonthlyPricePerUser.toFixed(0))} per user/mo`;
                    }
                }
                updateItemDetailDisplay(moduleData.id_checkbox, itemPerUserDisplay, "", key, 'module');
            }

            for (const key in pricing.addons) {
                const addonData = pricing.addons[key];
                const checkbox = document.getElementById(addonData.id_checkbox);
                const userInput = document.getElementById(addonData.id_user_input);
                const itemQuantity = parseInt(userInput.value) || 0;
                let itemPriceDisplayForCard = "$0";
                let addonDisplayCostForSummary = "$0";
                
                let pricePerUserAnnualEquiv = addonData.price_per_user_annual_equiv; // Base annual equivalent for the addon

                if (checkbox && checkbox.checked && itemQuantity > 0) {
                    totalMonthlySubscriptionCostAnnualEquiv += (pricePerUserAnnualEquiv * itemQuantity);
                    if (isAnnualBilling) {
                        itemPriceDisplayForCard = `$${formatNumberWithCommas(pricePerUserAnnualEquiv.toFixed(0))} per user/mo (annual billing)`;
                        addonDisplayCostForSummary = `$${formatNumberWithCommas((pricePerUserAnnualEquiv * itemQuantity * 12).toFixed(0))}/yr`;
                    } else {
                        let actualMonthlyPricePerUser = pricePerUserAnnualEquiv * pricing.monthly_premium_factor;
                        itemPriceDisplayForCard = `$${formatNumberWithCommas(actualMonthlyPricePerUser.toFixed(0))} per user/mo`;
                        addonDisplayCostForSummary = `$${formatNumberWithCommas((actualMonthlyPricePerUser * itemQuantity).toFixed(0))}/mo`;
                    }
                    summaryDetails.addonDetails.push({ name: addonData.name, users: itemQuantity, costDisplay: addonDisplayCostForSummary, unitName: addonData.unit_name || 'Users', key: key });
                } else if (key === 'tax_resolution') {
                    let priceForDisplay;
                    if (isAnnualBilling) {
                        priceForDisplay = pricePerUserAnnualEquiv;
                        itemPriceDisplayForCard = `$${formatNumberWithCommas(priceForDisplay.toFixed(0))} per user/mo (annual billing)`;
                    } else {
                        priceForDisplay = pricePerUserAnnualEquiv * pricing.monthly_premium_factor;
                        itemPriceDisplayForCard = `$${formatNumberWithCommas(priceForDisplay.toFixed(0))} per user/mo`;
                    }
                }
                updateItemDetailDisplay(addonData.id_checkbox, itemPriceDisplayForCard, "", key, 'addon');
            }


            const discountPercent = parseFloat(discountPercentageInput.value) || 0;
            summaryDetails.discountPercent = discountPercent;
            const discountDecimal = discountPercent / 100;

            let baseSubscriptionForPeriod;
            if (isAnnualBilling) {
                baseSubscriptionForPeriod = totalMonthlySubscriptionCostAnnualEquiv * 12;
            } else {
                baseSubscriptionForPeriod = totalMonthlySubscriptionCostAnnualEquiv * pricing.monthly_premium_factor;
            }
            
            let totalSubscriptionForPeriod = baseSubscriptionForPeriod + (isAnnualBilling ? directMonthlyCosts * 12 : directMonthlyCosts);

            summaryDetails.subscriptionSubtotalDisplay = `$${formatNumberWithCommas(totalSubscriptionForPeriod.toFixed(0))}`; // Display total before discount

            const discountAmount = totalSubscriptionForPeriod * discountDecimal;
            const discountedSubscriptionTotalForPeriod = totalSubscriptionForPeriod - discountAmount;

            summaryDetails.discountAmountDisplay = `-$${formatNumberWithCommas(discountAmount.toFixed(0))}`;
            summaryDetails.numericSubscriptionForHeader = parseFloat(discountedSubscriptionTotalForPeriod.toFixed(0));
            summaryDetails.subscriptionHeaderSuffix = isAnnualBilling ? "/yr" : "/mo";
            summaryDetails.subscriptionForHeaderDescription = isAnnualBilling ? "" : "with annual contract";

            const annualEquivalentOfSubscriptionForImpl = (totalMonthlySubscriptionCostAnnualEquiv + directMonthlyCosts) * 12; // Total annual equivalent for impl.
            const annualEquivalentOfDiscountedSubscription = annualEquivalentOfSubscriptionForImpl * (1-discountDecimal);


            const selectedImplTierKey = implementationTierSelect.value;
            const currentImplTier = pricing.implementation_tiers[selectedImplTierKey];
            summaryDetails.implementationTierName = currentImplTier.name;
            let implPercentage = currentImplTier.percentage;
            let effectiveMinimumImplFee = currentImplTier.minimum_fee;

            let calculatedImplFee = annualEquivalentOfDiscountedSubscription * implPercentage;
            let baseImplementationFee = Math.max(calculatedImplFee, effectiveMinimumImplFee);
            let currentImplementationFee;

            if (manualImplFeeSet) {
                currentImplementationFee = parseFloat(implementationFeeInput.value) || 0;
            } else {
                currentImplementationFee = baseImplementationFee;
                implementationFeeInput.value = formatNumberWithCommas(currentImplementationFee.toFixed(0));
            }
            summaryDetails.implementationFeeForDisplay = `$${formatNumberWithCommas(currentImplementationFee.toFixed(0))}`;

            const selectedMigrationKey = dataMigrationSelect.value;
            const selectedMigrationFee = pricing.data_migration_options[selectedMigrationKey]?.price || 0;
            summaryDetails.dataMigrationFeeForDisplay = `$${formatNumberWithCommas(selectedMigrationFee.toFixed(0))}`;
            summaryDetails.dataMigrationName = pricing.data_migration_options[selectedMigrationKey]?.name.replace(/\s\(.*\)/, '') || '';

            const totalOneTimeFees = currentImplementationFee + selectedMigrationFee;
            const grandTotalNumeric = discountedSubscriptionTotalForPeriod + totalOneTimeFees;
            summaryDetails.grandTotalForBreakdownDisplay = `$${formatNumberWithCommas(grandTotalNumeric.toFixed(0))}`;

            updateSummaryPanel(summaryDetails);
        }

        function setInitialYear() {
            currentYearSpan.textContent = "2025 Canopy";
        }

        // --- Event Listeners ---
        billingToggleInput.addEventListener('change', () => {
            manualImplFeeSet = false;
            toggleBillingCycle();
        });

        ceTierStandardButton.addEventListener('click', () => {
            selectedCEtierValue = 'standard';
            clientEngagementTierStandardRadio.checked = true;
            renderClientEngagementDetails();
            calculateAndUpdatePrice();
        });
        ceTierProButton.addEventListener('click', () => {
            selectedCEtierValue = 'pro';
            clientEngagementTierProRadio.checked = true;
            renderClientEngagementDetails();
            calculateAndUpdatePrice();
        });

        implementationTierSelect.addEventListener('change', () => {
            manualImplFeeSet = false;
            if (implementationTierSelect.value && pricing.implementation_tiers[implementationTierSelect.value]) {
                implementationInfoLink.href = pricing.implementation_tiers[implementationTierSelect.value].info_link;
            } else {
                implementationInfoLink.href = "#";
            }
            calculateAndUpdatePrice();
        });
        discountPercentageInput.addEventListener('input', calculateAndUpdatePrice);
        implementationFeeInput.addEventListener('input', () => {
            manualImplFeeSet = true;
            calculateAndUpdatePrice();
        });
        dataMigrationSelect.addEventListener('change', calculateAndUpdatePrice);

        // --- Initializations ---
        document.addEventListener('DOMContentLoaded', () => {
            populateImplementationTiers();
            populateDataMigrationOptions();
            renderClientEngagementDetails(); // Render CE details first to create additionalClientsInput
            renderAllSelectableItems();


            isAnnualBilling = billingToggleInput.checked;
            monthlyLabel.classList.toggle('active', !isAnnualBilling);
            annualLabel.classList.toggle('active', isAnnualBilling);
            updateBasePackageTierDisplay();
            // renderClientEngagementDetails(); // Already called above
            calculateAndUpdatePrice(); 
            setInitialYear();
        });
    </script>
</body>
</html>