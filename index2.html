<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canopy Pricing Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F1F3F7; 
        }
        .canopy-primary-accent { 
            background-color: #0BE6C7;
        }
        .canopy-primary-accent-text { 
            color: #0BE6C7;
        }
        .canopy-primary-accent-border { 
            border-color: #0BE6C7 !important; 
        }
        .item-selected-border { 
            border-color: #0BE6C7 !important;
            border-width: 2px !important;
        }
        .canopy-main-text { 
            color: #000000; 
        }
        .canopy-secondary-text { 
            color: #374151; 
        }
        .billing-toggle-bg {
            background-color: #e2e8f0; 
        }
        .billing-label.active {
            color: #0BE6C7; 
            font-weight: 600;
        }
        .custom-checkbox:checked {
            background-color: #0BE6C7;
            border-color: #0BE6C7;
        }
        input[type="text"].implementation-fee-input-display { 
            border: 1px solid #cbd5e0;
            padding: 0.35rem 0.5rem;
            border-radius: 0.375rem;
            width: 96px; 
            text-align: right; 
            color: #000000; 
            font-weight: 600;
        }
        input[type="number"].module-user-input, 
        input[type="number"].discount-input {
            border: 1px solid #cbd5e0;
            padding: 0.35rem 0.5rem;
            border-radius: 0.375rem;
            width: 80px; 
            text-align: center;
            color: #000000; 
        }
        input[type="number"].module-user-input:disabled {
            background-color: #edf2f7;
            cursor: not-allowed;
        }
        
        .summary-panel {
            background-color: #000000; 
            color: #FFFFFF; 
            border-left: none; 
        }
        .summary-panel-header-total {
            text-align: center;
            padding-top: 1rem;
            padding-bottom: 0.5rem; 
            border-bottom: 1px solid #4A5563; 
            margin-bottom: 1rem; 
        }
        .summary-panel-header-total .price {
            font-size: 3rem; 
            font-weight: 800; 
            line-height: 1;
        }
        .summary-panel-header-total .price-term {
            font-size: 1rem; 
            color: #D1D5DB; 
            display: block;
            margin-top: 0.25rem;
        }
        .summary-panel-header-total .one-time-fee-note {
            font-size: 0.75rem; 
            color: #9CA3AF; 
            margin-top: 0.25rem;
        }

        .summary-item {
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr; 
            gap: 0.5rem; 
            padding: 0.65rem 0; 
            border-bottom: 1px solid #4A5563; 
            font-size: 0.875rem;
            align-items: center;
        }
        .summary-item:last-child { 
            border-bottom: none;
        }
        .summary-item-label {
            color: #D1D5DB; 
            font-weight: 500;
        }
        .summary-item-quantity {
            color: #D1D5DB;
            text-align: center;
        }
        .summary-item-value {
            color: #FFFFFF; 
            font-weight: 600; 
            text-align: right;
        }
        .summary-grand-total .summary-item-label, 
        .summary-grand-total .summary-item-value { 
            font-size: 1.25rem; 
            font-weight: 700;
        }
        .summary-grand-total .canopy-primary-accent-text {
             color: #0BE6C7 !important;
        }

        .discreet-discount-input { 
            border: 1px solid #e2e8f0; 
            background-color: #f9fafb; 
            color: #a0aec0; 
            width: 70px; 
        }
        .peer:checked + span { 
            background-color: #0BE6C7 !important; 
        }

        /* Client Engagement Platform Styling */
        .ce-tier-selector {
            display: flex;
            margin-bottom: 0.5rem; 
            border: 1px solid #D1D5DB; 
            border-radius: 0.375rem; 
            overflow: hidden;
        }
        .ce-tier-button {
            flex: 1;
            padding: 0.75rem 1rem; 
            text-align: center;
            background-color: #FFFFFF;
            color: #374151; 
            cursor: pointer;
            border-right: 1px solid #D1D5DB;
            transition: background-color 0.2s ease-in-out;
        }
        .ce-tier-button:last-child {
            border-right: none;
        }
        .ce-tier-button.active {
            background-color: #0BE6C7;
            color: #FFFFFF;
            font-weight: 600;
        }
        .ce-tier-button .tier-name {
            display: block;
            font-size: 1rem; 
            font-weight: 700; 
        }
        .ce-tier-button .tier-recommendation {
            display: block;
            font-size: 0.7rem; 
            color: #6B7280; 
            margin-top: 0.1rem;
        }
        .ce-tier-button.active .tier-recommendation {
            color: #E0FEFA; 
        }
        .ce-tier-button .tier-price { 
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 0.25rem;
        }
        .ce-tier-button.active .tier-price {
            color: #FFFFFF; 
        }


        /* Module Card Styling */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); 
            gap: 1rem; 
        }
        .module-card, .addon-card { 
            background-color: #FFFFFF;
            border: 1px solid #e2e8f0; 
            border-radius: 0.5rem;
            padding: 1.25rem; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: border-color 0.2s ease-in-out, border-width 0.2s ease-in-out; 
            cursor: pointer; 
        }
        .addon-card { 
            padding: 0.75rem;
        }
        .module-card-header, .addon-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem; 
        }
        .module-card-title, .addon-card-title {
            font-size: 1.05rem; 
            font-weight: 700; 
            color: #000000;
        }
        .module-card-price {
            font-size: 1.35rem; 
            font-weight: 700; 
            color: #000000;
            margin-bottom: 0.15rem; 
            line-height: 1.2;
        }
        .module-card-price-term {
            font-size: 0.7rem; 
            color: #6B7280;
            display: block;
            margin-bottom: 0.75rem; 
        }
        .module-card-actions, .addon-card-actions { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto; 
            padding-top: 0.75rem; 
            border-top: 1px solid #e2e8f0;
        }
        .addon-card-description {
            font-size: 0.7rem; 
            color: #4A5568; 
            margin-bottom: 0.25rem; 
        }
        .addon-card-pricing {
            font-size: 0.8rem; 
            color: #374151; 
            margin-bottom: 0.25rem; 
        }
        .base-package-item, .adjustment-item { 
             border-bottom: 1px solid #e2e8f0;
            padding-top: 0.75rem; 
            padding-bottom: 0.75rem; 
        }
        .base-package-item:last-child, .adjustment-item:last-child {
            border-bottom: none;
        }

    </style>
</head>
<body class="canopy-main-text">

    <div class="w-full max-w-screen-2xl mx-auto p-4 md:p-6"> 
        <header class="text-center mb-8"> 
            <img src="Canopy Just logo Black.png" alt="Canopy Logo" class="mx-auto h-16 mb-3" onerror="this.style.display='none'; console.error('Logo image not found.')">
        </header>

        <div class="flex flex-col lg:flex-row gap-6"> 
            <div class="lg:w-3/5 bg-white p-4 md:p-6 rounded-lg shadow-xl"> 
                <div class="flex justify-center items-center mb-8"> 
                    <span id="monthlyLabel" class="billing-label canopy-secondary-text mr-3 text-sm md:text-base font-medium active">Monthly <span class="text-xs text-gray-500">(+20% Premium)</span></span>
                    <label for="billingToggleInput" class="relative inline-block w-12 h-6 billing-toggle-bg rounded-full cursor-pointer">
                        <input type="checkbox" id="billingToggleInput" class="sr-only peer">
                        <span class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-full peer-checked:bg-teal-500"></span> </label>
                    <span id="annualLabel" class="billing-label canopy-secondary-text ml-3 text-sm md:text-base font-medium">
                        Annually <span class="canopy-primary-accent-text text-xs" id="annualSavingText"></span>
                    </span>
                </div>

                <div class="mb-8"> <h3 class="text-lg font-semibold canopy-main-text mb-3">Client Engagement Platform</h3> 
                    <div class="ce-tier-selector">
                        <div id="ceTierStandardButton" class="ce-tier-button active">
                            {/* Content will be injected by JS */}
                        </div>
                        <div id="ceTierProButton" class="ce-tier-button">
                            {/* Content will be injected by JS */}
                        </div>
                    </div>
                     <div class="hidden">
                        <input type="radio" name="clientEngagementTier" id="clientEngagementTierStandard" value="standard" checked>
                        <input type="radio" name="clientEngagementTier" id="clientEngagementTierPro" value="pro">
                    </div>
                </div>


                <div class="mb-8">
                    <h3 class="text-lg font-semibold canopy-main-text mb-3">Modules</h3> 
                    <div id="selectableModulesContainer" class="modules-grid"></div>
                </div>
                
                <div class="mb-5"> 
                    <h3 class="text-lg font-semibold canopy-main-text mb-2 border-b pb-1">Implementation & Onboarding</h3> 
                    <div class="base-package-item" style="border-bottom: none; padding-top: 0.5rem; padding-bottom: 0.5rem;"> 
                         <div class="flex justify-between items-center"> 
                            <span class="text-sm canopy-secondary-text">Implementation Fee:</span>
                            <input type="text" id="implementationFeeInputDisplay" name="implementationFeeInputDisplay" value="$0" class="implementation-fee-input font-semibold w-24 text-right"> 
                        </div>
                    </div>
                </div>
                                
                <div class="mt-4 pt-3 border-t border-dashed border-gray-300"> 
                     <div class="item-content justify-end">
                         <input type="number" id="discountPercentage" name="discountPercentage" value="0" min="0" max="100" class="discount-input discreet-discount-input w-20" placeholder="%">
                     </div>
                </div>
            </div>

            <div class="lg:w-2/5 flex flex-col gap-6"> 
                <div class="summary-panel p-4 md:p-6 rounded-lg shadow-lg"> 
                    <div id="summaryPanelHeaderTotal">
                        {/* Big total will be injected here by JS */}
                    </div>
                    <div id="summaryPanelContent" class="space-y-1"> </div>
                </div>
                <div class="bg-white p-4 md:p-6 rounded-lg shadow-xl">
                     <h3 class="text-lg font-semibold canopy-main-text mb-3 border-b pb-2">Add-ons</h3>
                     <div id="addonsContainerSummary" class="space-y-2"> 
                     </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-10 text-sm text-gray-500"> 
            <p>&copy; <span id="currentYear"></span> Canopy</p>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const billingToggleInput = document.getElementById('billingToggleInput');
        const monthlyLabel = document.getElementById('monthlyLabel');
        const annualLabel = document.getElementById('annualLabel');
        
        const currentYearSpan = document.getElementById('currentYear');
        const annualSavingText = document.getElementById('annualSavingText'); 
        const discountPercentageInput = document.getElementById('discountPercentage');
        const implementationFeeInputDisplay = document.getElementById('implementationFeeInputDisplay'); 
        
        const selectableModulesContainer = document.getElementById('selectableModulesContainer');
        const addonsContainerSummary = document.getElementById('addonsContainerSummary'); 
        const summaryPanelContent = document.getElementById('summaryPanelContent');
        const summaryPanelHeaderTotal = document.getElementById('summaryPanelHeaderTotal'); 

        const ceTierStandardButton = document.getElementById('ceTierStandardButton');
        const ceTierProButton = document.getElementById('ceTierProButton');
        const clientEngagementTierStandardRadio = document.getElementById('clientEngagementTierStandard');
        const clientEngagementTierProRadio = document.getElementById('clientEngagementTierPro');


        // --- Pricing Configuration ---
        const pricing = {
            monthly_premium_factor: 1.20, 
            base_client_engagement: { 
                standard: { 
                    name: "Client Engagement - Standard", 
                    effective_monthly_rate_on_annual_plan: 150, 
                    implementation_percentage: 0.15,
                    recommendation: "Recommended for small firms"
                }, 
                pro: { 
                    name: "Client Engagement - Pro", 
                    effective_monthly_rate_on_annual_plan: 175, 
                    implementation_percentage: 0.20,
                    recommendation: "Recommended for growing firms"
                }
            },
            implementation_minimum_fee: 1500,
            selectable_modules: { 
                document_management: {
                    name: "Document Management",
                    id_checkbox: "moduleDocManagementCheck",
                    id_user_input: "moduleDocManagementUsers",
                    standard_tier_pricing: [ 
                        { user_max: 4, price_per_user_annual_equiv: 40 },
                        { user_max: 9, price_per_user_annual_equiv: 36 },
                        { user_max: Infinity, price_per_user_annual_equiv: 40 * (1 - 0.15) } 
                    ],
                    pro_tier_pricing: [ 
                        { user_max: 4, price_per_user_annual_equiv: 40 },
                        { user_max: 9, price_per_user_annual_equiv: 36 },
                        { user_max: Infinity, price_per_user_annual_equiv: 40 * (1 - 0.15) }
                    ]
                },
                workflow: { 
                    name: "Workflow",
                    id_checkbox: "moduleWorkflowCheck",
                    id_user_input: "moduleWorkflowUsers",
                    standard_tier_pricing: [
                        { user_max: 4, price_per_user_annual_equiv: 35 },
                        { user_max: 9, price_per_user_annual_equiv: 32 },
                        { user_max: Infinity, price_per_user_annual_equiv: 35 * (1 - 0.15) }
                    ],
                    pro_tier_pricing: [
                        { user_max: 4, price_per_user_annual_equiv: 45 },
                        { user_max: 9, price_per_user_annual_equiv: 45 * (1 - 0.10) }, 
                        { user_max: Infinity, price_per_user_annual_equiv: 45 * (1 - 0.15) } 
                    ]
                },
                time_billing: {
                    name: "Time & Billing",
                    id_checkbox: "moduleTimeBillingCheck",
                    id_user_input: "moduleTimeBillingUsers",
                    standard_tier_pricing: [
                        { user_max: 4, price_per_user_annual_equiv: 25 },
                        { user_max: 9, price_per_user_annual_equiv: 22 },
                        { user_max: Infinity, price_per_user_annual_equiv: 25 * (1 - 0.15) }
                    ],
                    pro_tier_pricing: [
                        { user_max: 4, price_per_user_annual_equiv: 35 },
                        { user_max: 9, price_per_user_annual_equiv: 35 * (1 - 0.10) },
                        { user_max: Infinity, price_per_user_annual_equiv: 35 * (1 - 0.15) }
                    ]
                }
            },
            addons: {
                tax_resolution: {
                    name: "Tax Resolution Suite",
                    description: "includes Transcripts and Notices",
                    id_checkbox: "addonTaxResolutionCheck",
                    id_user_input: "addonTaxResolutionUsers",
                    price_per_user_annual_equiv: 50,
                    is_primary_style: true 
                }
            }
        };

        let isAnnualBilling = false; 
        let selectedCEtierValue = 'standard'; 
        let manualImplFeeSet = false; 

        // --- Functions ---

        function formatCurrency(number, includeDecimals = false) {
            const options = {
                minimumFractionDigits: includeDecimals ? 2 : 0,
                maximumFractionDigits: includeDecimals ? 2 : 0,
            };
            return number.toLocaleString(undefined, options);
        }


        function renderClientEngagementDetails() { 
            const standardData = pricing.base_client_engagement.standard;
            const proData = pricing.base_client_engagement.pro;
            let standardPriceText, proPriceText;

            if (isAnnualBilling) {
                standardPriceText = `$${formatCurrency(standardData.effective_monthly_rate_on_annual_plan)}/mo <span class="block text-xs normal-case opacity-75">with annual contract</span>`;
                proPriceText = `$${formatCurrency(proData.effective_monthly_rate_on_annual_plan)}/mo <span class="block text-xs normal-case opacity-75">with annual contract</span>`;
            } else {
                standardPriceText = `$${formatCurrency(standardData.effective_monthly_rate_on_annual_plan * pricing.monthly_premium_factor)}/mo <span class="block text-xs normal-case opacity-75">for unlimited users</span>`;
                proPriceText = `$${formatCurrency(proData.effective_monthly_rate_on_annual_plan * pricing.monthly_premium_factor)}/mo <span class="block text-xs normal-case opacity-75">for unlimited users</span>`;
            }

            ceTierStandardButton.innerHTML = `
                <span class="tier-name">STANDARD</span>
                <span class="tier-recommendation">${standardData.recommendation}</span>
                <span class="tier-price">${standardPriceText}</span>
            `;
            ceTierProButton.innerHTML = `
                <span class="tier-name">PRO</span>
                <span class="tier-recommendation">${proData.recommendation}</span>
                <span class="tier-price">${proPriceText}</span>
            `;
            
            ceTierStandardButton.classList.toggle('active', selectedCEtierValue === 'standard');
            ceTierProButton.classList.toggle('active', selectedCEtierValue === 'pro');
        }


        function createSelectableItemEntry(key, itemData, container, itemType) {
            const div = document.createElement('div');
            div.className = itemType === 'module' ? 'module-card' : 'addon-card'; 
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = itemData.id_checkbox;
            checkbox.name = itemData.id_checkbox;
            checkbox.className = 'custom-checkbox h-5 w-5 border-gray-300 rounded focus:ring-transparent flex-shrink-0';
            checkbox.dataset.itemKey = key;
            checkbox.dataset.itemType = itemType;

            const userInput = document.createElement('input');
            userInput.type = 'number';
            userInput.id = itemData.id_user_input;
            userInput.name = itemData.id_user_input;
            userInput.value = "0";
            userInput.min = "0";
            userInput.className = 'module-user-input';
            userInput.disabled = true;
            
            if (itemType === 'addon') {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'addon-card-header'; 
                const titleSpan = document.createElement('span');
                titleSpan.className = 'addon-card-title text-lg'; 
                titleSpan.textContent = itemData.name;
                
                headerDiv.appendChild(titleSpan);
                headerDiv.appendChild(checkbox);
                div.appendChild(headerDiv);

                if (itemData.description) {
                    const descP = document.createElement('p');
                    descP.className = 'addon-card-description';
                    descP.textContent = itemData.description;
                    div.appendChild(descP);
                }
                const pricingP = document.createElement('p');
                pricingP.className = 'addon-card-pricing'; 
                pricingP.id = `${itemData.id_checkbox}_price_display`;
                div.appendChild(pricingP);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'item-actions mt-2'; 
                const userLabelText = itemData.is_consumption_based ? (itemData.unit_name || "Quantity") + ":" : "Users:";
                const userLabel = document.createElement('label');
                userLabel.htmlFor = itemData.id_user_input;
                userLabel.className = 'text-xs text-gray-600 mr-2';
                userLabel.textContent = userLabelText;
                
                actionsDiv.appendChild(userLabel);
                actionsDiv.appendChild(userInput);
                div.appendChild(actionsDiv);

            } else { // Module Card Styling
                const headerDiv = document.createElement('div');
                headerDiv.className = 'module-card-header';
                const titleSpan = document.createElement('h4');
                titleSpan.className = 'module-card-title';
                titleSpan.textContent = itemData.name;
               
                headerDiv.appendChild(titleSpan);
                headerDiv.appendChild(checkbox); 
                div.appendChild(headerDiv);

                const priceDiv = document.createElement('div');
                priceDiv.className = 'module-card-price';
                priceDiv.id = `${itemData.id_checkbox}_price_display`;
                priceDiv.textContent = '$0'; 
                div.appendChild(priceDiv);

                const priceTermSpan = document.createElement('span');
                priceTermSpan.className = 'module-card-price-term';
                priceTermSpan.id = `${itemData.id_checkbox}_price_term_display`;
                priceTermSpan.textContent = 'per user/mo'; 
                div.appendChild(priceTermSpan);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'module-card-actions';
                const userLabel = document.createElement('label');
                userLabel.htmlFor = itemData.id_user_input;
                userLabel.className = 'text-xs text-gray-600 mr-2';
                userLabel.textContent = 'Users:';
                
                actionsDiv.appendChild(userLabel);
                actionsDiv.appendChild(userInput); 
                div.appendChild(actionsDiv);
            }
            
            div.addEventListener('click', (event) => {
                if (event.target !== userInput && event.target !== checkbox && !event.target.closest('label[for="' + userInput.id + '"]')) {
                    checkbox.checked = !checkbox.checked;
                    const changeEvent = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(changeEvent);
                }
            });

            checkbox.addEventListener('change', (event) => {
                userInput.disabled = !event.target.checked;
                div.classList.toggle('item-selected-border', event.target.checked);
                if (!event.target.checked) {
                    userInput.value = "0"; 
                } else if (userInput.value === "0") {
                    userInput.value = itemData.is_consumption_based ? "10" : "1";
                }
                calculateAndUpdatePrice();
            });
            userInput.addEventListener('input', calculateAndUpdatePrice);
            container.appendChild(div);
        }

        function renderAllSelectableItems() {
            selectableModulesContainer.innerHTML = '';
            addonsContainerSummary.innerHTML = ''; 

            for (const key in pricing.selectable_modules) {
                createSelectableItemEntry(key, pricing.selectable_modules[key], selectableModulesContainer, 'module');
            }
            for (const key in pricing.addons) {
                createSelectableItemEntry(key, pricing.addons[key], addonsContainerSummary, 'addon');
            }
        }

        function toggleBillingCycle() {
            isAnnualBilling = billingToggleInput.checked; 
            monthlyLabel.classList.toggle('active', !isAnnualBilling);
            annualLabel.classList.toggle('active', isAnnualBilling);
            renderClientEngagementDetails(); 
            calculateAndUpdatePrice();
        }

        function getPerUserAnnualEquivalentPrice(userCount, pricingTiersForItem) {
            if (!pricingTiersForItem) return 0;
            for (const tier of pricingTiersForItem) {
                if (userCount <= tier.user_max) {
                    return tier.price_per_user_annual_equiv;
                }
            }
            return 0; 
        }
        
        function updateSummaryPanel(summaryData) {
            summaryPanelHeaderTotal.innerHTML = `
                <div class="summary-panel-header-total">
                    <div class="price canopy-primary-accent-text">$${formatCurrency(summaryData.grandTotalDisplayRaw)}</div>
                    <div class="price-term">${summaryData.grandTotalFrequency}</div>
                    ${summaryData.showOneTimeFeeSeparatelyInGrandTotal ? `<div class="one-time-fee-note">+ $${formatCurrency(summaryData.implementationFeeRaw)} (One-Time)</div>` : ''}
                </div>
            `;

            summaryPanelContent.innerHTML = ''; 

            function addSummaryItem(label, quantity, value, isStrong = false, isGreen = false) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'summary-item';
                if (isStrong) itemDiv.classList.add('font-semibold');


                const labelSpan = document.createElement('span');
                labelSpan.className = 'summary-item-label';
                labelSpan.textContent = label;
                
                const quantitySpan = document.createElement('span');
                quantitySpan.className = 'summary-item-quantity';
                quantitySpan.textContent = quantity;

                const valueSpan = document.createElement('span');
                valueSpan.className = 'summary-item-value';
                if (isGreen) valueSpan.classList.add('canopy-primary-accent-text');
                valueSpan.textContent = value;
                
                itemDiv.appendChild(labelSpan);
                itemDiv.appendChild(quantitySpan);
                itemDiv.appendChild(valueSpan);
                summaryPanelContent.appendChild(itemDiv);
            }
            function addSummarySeparator() { 
                const separatorDiv = document.createElement('div');
                separatorDiv.className = 'pt-2 mt-2 border-t border-gray-700'; 
                summaryPanelContent.appendChild(separatorDiv);
            }

            addSummaryItem('Tier:', '', selectedCEtierValue === 'standard' ? 'Standard' : 'Pro'); 
            addSummaryItem('Client Engagement Platform:', '', summaryData.ceCostDisplay); 


            summaryData.moduleDetails.forEach(mod => { 
                addSummaryItem(mod.name, `${mod.users} ${mod.unitName || 'Users'}`, mod.costDisplay);
            });
            
            summaryData.addonDetails.forEach(addon => {
                addSummaryItem(addon.name, `${addon.users} ${addon.unitName || 'Users'}`, addon.costDisplay);
            });
            
            addSummarySeparator(); 

            if (summaryData.discountPercent > 0) {
                addSummaryItem('Subscription Subtotal:', '', `$${formatCurrency(summaryData.subscriptionSubtotalRaw)}`);
                addSummaryItem('Discount Applied:', `(${summaryData.discountPercent}%)`, `-$${formatCurrency(summaryData.discountAmountRaw)}`, false, true);
                addSummaryItem('Discounted Subscription:', '', `$${formatCurrency(summaryData.discountedSubscriptionTotalRaw)}`, true);
            } else {
                 addSummaryItem('Subscription Total:', '', `$${formatCurrency(summaryData.subscriptionSubtotalRaw)}`, true);
            }
            
            addSummarySeparator(); 

            addSummaryItem('One-Time Implementation:', '', `$${formatCurrency(summaryData.implementationFeeRaw)}`, false, false);
        }


        function calculateAndUpdatePrice() {
            let totalMonthlySubscriptionCostAnnualEquiv = 0; 
            const summaryDetails = {
                moduleDetails: [],
                addonDetails: [], 
                discountPercent: 0,
                subscriptionSubtotalRaw: 0, 
                discountAmountRaw: 0,
                discountedSubscriptionTotalRaw: 0,
                implementationFeeRaw: 0,
                grandTotalDisplayRaw: 0,
                ceCostDisplay: '$0',
                implementationFeeDisplay: '$0', 
                grandTotalDisplay: '$0', 
                grandTotalFrequency: 'per month',
                showOneTimeFeeSeparatelyInGrandTotal: false
            };

            summaryDetails.ceTierName = selectedCEtierValue.charAt(0).toUpperCase() + selectedCEtierValue.slice(1); 
            let baseCEAnnualEquivMonthlyRate = pricing.base_client_engagement[selectedCEtierValue].effective_monthly_rate_on_annual_plan;
            totalMonthlySubscriptionCostAnnualEquiv += baseCEAnnualEquivMonthlyRate;

            if (isAnnualBilling) {
                summaryDetails.ceCostDisplay = `$${formatCurrency(baseCEAnnualEquivMonthlyRate * 12)}/yr`;
            } else {
                summaryDetails.ceCostDisplay = `$${formatCurrency(baseCEAnnualEquivMonthlyRate * pricing.monthly_premium_factor)}/mo`;
            }

            function updateItemDetailDisplay(itemIdCheckbox, perUserCostText, itemTotalCostText, isModuleCard = true) {
                const priceDisplayEl = document.getElementById(`${itemIdCheckbox}_price_display`);
                const priceTermEl = document.getElementById(`${itemIdCheckbox}_price_term_display`); 
                
                if (isModuleCard && priceDisplayEl && priceTermEl) { 
                    const parts = perUserCostText.split('/mo');
                    priceDisplayEl.textContent = perUserCostText === "$0" ? "$0" : (parts[0] || '$0');
                    priceTermEl.textContent = perUserCostText === "$0" ? 'per user/mo' : (parts[1] ? `/mo${parts[1]}` : (isAnnualBilling ? '/user/mo (annual plan)' : '/user/mo'));
                } else if (!isModuleCard && priceDisplayEl) { 
                     priceDisplayEl.textContent = perUserCostText === "$0" ? (pricing.addons[document.getElementById(itemIdCheckbox).dataset.itemKey]?.is_consumption_based ? `$${pricing.addons[document.getElementById(itemIdCheckbox).dataset.itemKey].price_per_item.toFixed(2)} per ${pricing.addons[document.getElementById(itemIdCheckbox).dataset.itemKey].unit_name || 'item'}` : "$0") : perUserCostText;
                }
            }
            
            // Selectable Modules
            for (const key in pricing.selectable_modules) {
                const moduleData = pricing.selectable_modules[key];
                const checkbox = document.getElementById(moduleData.id_checkbox);
                const userInput = document.getElementById(moduleData.id_user_input);
                const moduleUsers = parseInt(userInput.value) || 0;

                let itemPerUserDisplay = "$0";
                let moduleDisplayCostForSummary = "$0"; 

                if (checkbox && checkbox.checked && moduleUsers > 0) {
                    const pricingTiers = selectedCEtierValue === 'pro' ? moduleData.pro_tier_pricing : moduleData.standard_tier_pricing;
                    let pricePerUserAnnualEquiv = getPerUserAnnualEquivalentPrice(moduleUsers, pricingTiers);
                    totalMonthlySubscriptionCostAnnualEquiv += (pricePerUserAnnualEquiv * moduleUsers);
                    
                    if (isAnnualBilling) {
                        itemPerUserDisplay = `$${formatCurrency(pricePerUserAnnualEquiv, true)}/mo (annual plan)`;
                        moduleDisplayCostForSummary = `$${formatCurrency(pricePerUserAnnualEquiv * moduleUsers * 12)}/yr`;
                    } else {
                        let actualMonthlyPricePerUser = pricePerUserAnnualEquiv * pricing.monthly_premium_factor;
                        itemPerUserDisplay = `$${formatCurrency(actualMonthlyPricePerUser, true)}/mo`;
                        moduleDisplayCostForSummary = `$${formatCurrency(actualMonthlyPricePerUser * moduleUsers)}/mo`;
                    }
                    summaryDetails.moduleDetails.push({ name: moduleData.name, users: moduleUsers, costDisplay: moduleDisplayCostForSummary, unitName: "Users" });
                }
                 updateItemDetailDisplay(moduleData.id_checkbox, itemPerUserDisplay, "", true); 
            }
            
            // Add-ons
            for (const key in pricing.addons) {
                const addonData = pricing.addons[key];
                const checkbox = document.getElementById(addonData.id_checkbox);
                const userInput = document.getElementById(addonData.id_user_input);
                const itemQuantity = parseInt(userInput.value) || 0;

                let itemPriceDisplayForCard = "$0"; 
                let addonDisplayCostForSummary = "$0"; 

                if (checkbox && checkbox.checked && itemQuantity > 0) {
                    if (addonData.is_consumption_based) { 
                        let itemCost = addonData.price_per_item * itemQuantity;
                        
                        if (isAnnualBilling) {
                            totalMonthlySubscriptionCostAnnualEquiv += itemCost; 
                            addonDisplayCostForSummary = `$${formatCurrency(itemCost * 12, true)}/yr`;
                        } else {
                            totalMonthlySubscriptionCostAnnualEquiv += itemCost; 
                            addonDisplayCostForSummary = `$${formatCurrency(itemCost, true)}/mo`;
                        }
                        itemPriceDisplayForCard = `$${formatCurrency(addonData.price_per_item, true)} per ${addonData.unit_name || 'item'}`;

                    } else { 
                        let pricePerUserAnnualEquiv = addonData.price_per_user_annual_equiv; 
                        totalMonthlySubscriptionCostAnnualEquiv += (pricePerUserAnnualEquiv * itemQuantity);
                        if (isAnnualBilling) {
                            itemPriceDisplayForCard = `$${formatCurrency(pricePerUserAnnualEquiv, true)}/user/mo (annual billing)`;
                            addonDisplayCostForSummary = `$${formatCurrency(pricePerUserAnnualEquiv * itemQuantity * 12)}/yr`;
                        } else {
                            let actualMonthlyPricePerUser = pricePerUserAnnualEquiv * pricing.monthly_premium_factor;
                            itemPriceDisplayForCard = `$${formatCurrency(actualMonthlyPricePerUser, true)}/user/mo`;
                            addonDisplayCostForSummary = `$${formatCurrency(actualMonthlyPricePerUser * itemQuantity)}/mo`;
                        }
                    }
                    summaryDetails.addonDetails.push({ name: addonData.name, users: itemQuantity, costDisplay: addonDisplayCostForSummary, unitName: addonData.unit_name || (addonData.is_consumption_based ? 'items' : 'Users') });
                } else if (addonData.is_consumption_based) { 
                     itemPriceDisplayForCard = `$${formatCurrency(addonData.price_per_item, true)} per ${addonData.unit_name || 'item'}`;
                }
                updateItemDetailDisplay(addonData.id_checkbox, itemPriceDisplayForCard, "", false); 
            }

            const discountPercent = parseFloat(discountPercentageInput.value) || 0;
            summaryDetails.discountPercent = discountPercent;
            const discountDecimal = discountPercent / 100;
            
            let subscriptionSubtotalForPeriod; 
            if (isAnnualBilling) {
                subscriptionSubtotalForPeriod = totalMonthlySubscriptionCostAnnualEquiv * 12;
            } else {
                subscriptionSubtotalForPeriod = totalMonthlySubscriptionCostAnnualEquiv * pricing.monthly_premium_factor;
            }
            summaryDetails.subscriptionSubtotalRaw = subscriptionSubtotalForPeriod;

            const discountAmount = subscriptionSubtotalForPeriod * discountDecimal;
            const discountedSubscriptionTotalForPeriod = subscriptionSubtotalForPeriod - discountAmount;
            summaryDetails.discountAmountRaw = discountAmount;
            summaryDetails.discountedSubscriptionTotalRaw = discountedSubscriptionTotalForPeriod;

            const annualEquivalentOfSubscriptionForImpl = totalMonthlySubscriptionCostAnnualEquiv * 12; 
            const annualEquivalentOfDiscountedSubscription = annualEquivalentOfSubscriptionForImpl * (1 - discountDecimal);
            
            let implPercentage = pricing.base_client_engagement[selectedCEtierValue].implementation_percentage;
            let calculatedImplFee = annualEquivalentOfDiscountedSubscription * implPercentage;
            let oneTimeImplementationFeeFromCalc = Math.max(calculatedImplFee, pricing.implementation_minimum_fee);
            
            let currentImplementationFee;
            const rawImplFeeValue = implementationFeeInputDisplay.value.replace(/\$/g, '').replace(/,/g, ''); 
            if (manualImplFeeSet && rawImplFeeValue !== "" && !isNaN(parseFloat(rawImplFeeValue))) {
                currentImplementationFee = parseFloat(rawImplFeeValue);
            } else {
                currentImplementationFee = oneTimeImplementationFeeFromCalc;
                manualImplFeeSet = false; 
            }
            implementationFeeInputDisplay.value = `$${formatCurrency(currentImplementationFee)}`; 
            summaryDetails.implementationFeeRaw = currentImplementationFee;
            summaryDetails.implementationFeeDisplay = `$${formatCurrency(currentImplementationFee)}`;

            let grandTotalForSummary = 0; 
            
            if (isAnnualBilling) {
                grandTotalForSummary = discountedSubscriptionTotalForPeriod + currentImplementationFee;
                summaryDetails.grandTotalFrequency = "with annual contract"; 
                summaryDetails.showOneTimeFeeSeparatelyInGrandTotal = false;
            } else {
                grandTotalForSummary = discountedSubscriptionTotalForPeriod; 
                summaryDetails.grandTotalFrequency = "/mo";
                summaryDetails.showOneTimeFeeSeparatelyInGrandTotal = true;
            }
            
            summaryDetails.grandTotalDisplayRaw = grandTotalForSummary; 
            updateSummaryPanel(summaryDetails); 
        }

        function setInitialYear() {
            currentYearSpan.textContent = "2025 Canopy";
        }

        // --- Event Listeners ---
        billingToggleInput.addEventListener('change', () => {
            manualImplFeeSet = false; 
            toggleBillingCycle();
        });
        
        ceTierStandardButton.addEventListener('click', () => {
            if (selectedCEtierValue !== 'standard') manualImplFeeSet = false;
            selectedCEtierValue = 'standard';
            clientEngagementTierStandardRadio.checked = true; 
            renderClientEngagementDetails();
            calculateAndUpdatePrice();
        });
        ceTierProButton.addEventListener('click', () => {
            if (selectedCEtierValue !== 'pro') manualImplFeeSet = false;
            selectedCEtierValue = 'pro';
            clientEngagementTierProRadio.checked = true; 
            renderClientEngagementDetails();
            calculateAndUpdatePrice();
        });
        discountPercentageInput.addEventListener('input', () => {
            if (!manualImplFeeSet) { 
            }
            calculateAndUpdatePrice();
        });
        
        implementationFeeInputDisplay.addEventListener('input', (event) => {
            manualImplFeeSet = true;
            let value = event.target.value.replace(/[^\d.]/g, '');
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            // Do not reformat here, just use the raw numeric input for calculation
            // Formatting will happen in calculateAndUpdatePrice or on blur
            calculateAndUpdatePrice(); 
        });

        implementationFeeInputDisplay.addEventListener('blur', () => { 
            const rawValue = implementationFeeInputDisplay.value.replace(/\$/g, '').replace(/,/g, '');
            let numericValue = parseFloat(rawValue);

            if (isNaN(numericValue) || numericValue < 0 ) { 
                manualImplFeeSet = false; 
            } else {
                implementationFeeInputDisplay.value = `$${formatCurrency(numericValue)}`; 
                // manualImplFeeSet remains true if user entered a valid number
            }
            calculateAndUpdatePrice(); 
        });


        // --- Initializations ---
        document.addEventListener('DOMContentLoaded', () => {
            renderAllSelectableItems(); 
            
            isAnnualBilling = billingToggleInput.checked; 
            monthlyLabel.classList.toggle('active', !isAnnualBilling);
            annualLabel.classList.toggle('active', isAnnualBilling);
            
            renderClientEngagementDetails(); 
            calculateAndUpdatePrice(); 
            setInitialYear();
        });
    </script>
</body>
</html>
